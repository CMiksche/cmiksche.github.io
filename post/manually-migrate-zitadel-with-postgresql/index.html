<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Manually Migrate ZITADEL with PostgreSQL :: M5E&#39;s Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="As you, the reader, found this article, it is likely that you want to manually migrate the ZITADEL PostgreSQL database to a new version.
Now, normally this step is being done by the zitadel setup command with the --init-projections=true flag but, as we all know since &amp;ldquo;2001: A Space Odyssey&amp;rdquo;, computers can&amp;rsquo;t be trusted - so you are either paranoid or something went terribly wrong.
For manually updating the database, we should first understand the structure a bit." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://blog.m5e.de/post/manually-migrate-zitadel-with-postgresql/" />






  
  
  
  
  
  <link rel="stylesheet" href="https://blog.m5e.de/styles.css">



<link rel="stylesheet" href="https://blog.m5e.de/style.css">



  <link rel="shortcut icon" href="https://blog.m5e.de/img/theme-colors/orange.png">
  <link rel="apple-touch-icon" href="https://blog.m5e.de/img/theme-colors/orange.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="CMiksche" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Manually Migrate ZITADEL with PostgreSQL">
<meta property="og:description" content="As you, the reader, found this article, it is likely that you want to manually migrate the ZITADEL PostgreSQL database to a new version.
Now, normally this step is being done by the zitadel setup command with the --init-projections=true flag but, as we all know since &amp;ldquo;2001: A Space Odyssey&amp;rdquo;, computers can&amp;rsquo;t be trusted - so you are either paranoid or something went terribly wrong.
For manually updating the database, we should first understand the structure a bit." />
<meta property="og:url" content="https://blog.m5e.de/post/manually-migrate-zitadel-with-postgresql/" />
<meta property="og:site_name" content="M5E&#39;s Blog" />

  
    <meta property="og:image" content="https://blog.m5e.de/img/favicon/orange.png">
  

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2024-02-17 00:00:00 &#43;0000 UTC" />









<script async src="https://a.chapati.systems/script.js" data-website-id="3e433b5d-32c7-4c9a-b9f5-fd81120a30fb"></script>
<link href="/css/fontawesome.css" rel="stylesheet">
<link href="/css/brands.css" rel="stylesheet">
<link href="/css/solid.css" rel="stylesheet">


</head>
<body class="orange">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    M5E&#39;s Blog
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;â–¾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="https://github.com/cmiksche">GitHub</a></li>
        
      
        
          <li><a href="https://twitter.com/cmiksche">Twitter</a></li>
        
      
        
          <li><a href="https://mastodon.social/@cmiksche">Mastodon</a></li>
        
      
        
          <li><a href="https://linkedin.com/in/cmiksche/">LinkedIn</a></li>
        
      
        
          <li><a href="https://www.instagram.com/cmiksche/">Instagram</a></li>
        
      
        
          <li><a href="/">Home</a></li>
        
      
        
          <li><a href="/uses">Uses</a></li>
        
      
        
          <li><a href="/contact">Contact &amp; Imprint</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          
          <li><a href="https://github.com/cmiksche"><i class="fab fa-github"></i></a></li>
          
        
      
        
          
          <li><a href="https://twitter.com/cmiksche"><i class="fab fa-x-twitter"></i></a></li>
          
        
      
        
          
          <li><a href="https://mastodon.social/@cmiksche"><i class="fab fa-mastodon"></i></a></li>
          
        
      
        
          
          <li><a href="https://linkedin.com/in/cmiksche/"><i class="fab fa-linkedin"></i></a></li>
          
        
      
        
          
          <li><a href="https://www.instagram.com/cmiksche/"><i class="fab fa-instagram"></i></a></li>
          
        
      
        
          
            <li><a href="/" >Home</a></li>
          
        
      
        
          
            <li><a href="/uses" >Uses</a></li>
          
        
      
        
          
            <li><a href="/contact" >Contact &amp; Imprint</a></li>
          
        
      
      
    
  </ul>
</nav>
  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://blog.m5e.de/post/manually-migrate-zitadel-with-postgresql/">Manually Migrate ZITADEL with PostgreSQL</a>
  </h1>
  <div class="post-meta">
    
      <time class="post-date">
        2024-02-17 ::
        
      </time>
    
    
    
  </div>

  
    <span class="post-tags">
      
      #<a href="https://blog.m5e.de/tags/Manually/">Manually</a>&nbsp;
      
      #<a href="https://blog.m5e.de/tags/Migrate/">Migrate</a>&nbsp;
      
      #<a href="https://blog.m5e.de/tags/ZITADEL/">ZITADEL</a>&nbsp;
      
      #<a href="https://blog.m5e.de/tags/PostgreSQL/">PostgreSQL</a>&nbsp;
      
      #<a href="https://blog.m5e.de/tags/Open/">Open</a>&nbsp;
      
      #<a href="https://blog.m5e.de/tags/Source/">Source</a>&nbsp;
      
      #<a href="https://blog.m5e.de/tags/Authentication/">Authentication</a>&nbsp;
      
      #<a href="https://blog.m5e.de/tags/OAuth/">OAuth</a>&nbsp;
      
      #<a href="https://blog.m5e.de/tags/OpenID/">OpenID</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <p>As you, the reader, found this article, it is likely that you want to manually migrate the ZITADEL PostgreSQL database to a new version.</p>
<p>Now, normally this step is being done by the <code>zitadel setup</code> command with the <code>--init-projections=true</code> flag but, as we all know since &ldquo;2001: A Space Odyssey&rdquo;, computers can&rsquo;t be trusted - so you are either paranoid or something went terribly wrong.</p>
<p>For manually updating the database, we should first understand the structure a bit. So far, the Zitadel Team seems to use versioning for their tables - meaning they create a new table for every change instead of just altering the current table. This leads to some beautifully structured schemas full of tables like <code>users6</code>, <code>users7</code> and <code>users8</code> up to <code>users10</code>.</p>
<p>I don&rsquo;t know if this structure is still there at the time of you reading this, but in this post I will just go with the assumption that Zitadel Developers are afraid of altering and love version numbers.</p>
<h2 id="common-problems">Common Problems<a href="#common-problems" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>The reason, I write this article, is my database wasn&rsquo;t migrated correctly. In my case the command said everything is migrated, but then I encountered errors like <code>unable to retrieve client by id</code>, <code>migration already started, will check again in 5 seconds</code> or <code>{&quot;error&quot;:&quot;invalid_request&quot;,&quot;error_description&quot;:&quot;Errors.App.NotFound&quot;}</code>.</p>
<p>All of these errors point to the database. In my case all the new tables were created but some of the data was still only in the old tables and in other cases only some of the rows got copied into the new tables.</p>
<h2 id="manually-migrating">Manually Migrating<a href="#manually-migrating" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Before continuing, I would recommend that all the following steps are being done on a cloned instance, not on the production setup. You should also write down every SQL query you create so that you can reproduce the migration in case it was successful on the test instance.</p>
<h3 id="identifying-the-right-tables">Identifying the right tables<a href="#identifying-the-right-tables" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>To migrate the database, you should first be sure what the current tables are. At the time of me writing this, this is normally the table with the highest number - e.g. <code>projections.apps6</code> instead of <code>projections.apps4</code>.</p>
<p>Now, you should make sure that this table is actually the right table - what if the table didn&rsquo;t even get created? You can take a look at the source code.</p>
<p>Currently, the projections are in the <code>zitadel/internal/query/projection</code> folder. Example: the <code>app.go</code> file has the following lines:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">AppProjectionTable</span> = <span style="color:#e6db74">&#34;projections.apps6&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AppAPITable</span>        = <span style="color:#a6e22e">AppProjectionTable</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;_&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">appAPITableSuffix</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AppOIDCTable</span>       = <span style="color:#a6e22e">AppProjectionTable</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;_&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">appOIDCTableSuffix</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AppSAMLTable</span>       = <span style="color:#a6e22e">AppProjectionTable</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;_&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">appSAMLTableSuffix</span>
</span></span></code></pre></div><p>This gives us already 4 current table names. You should make sure that you check out the right version tag on GitHub so that you don&rsquo;t look at outdated or Code which is still in development.</p>
<p>We should also first do the tables without foreign keys, only after that the tables with foreign keys.</p>
<h3 id="checking-columns">Checking Columns<a href="#checking-columns" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Next, we should make sure that the tables we want to migrate have the same columns. Some older tables have e.g. <code>owner_removed</code> columns which are <a href="https://github.com/zitadel/zitadel/issues/6885">not needed</a> anymore.</p>
<p>This can be done by e.g.:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">INDEX</span> projections.apps5_owner_removed_idx;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> projections.apps5 <span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">COLUMN</span> owner_removed;
</span></span></code></pre></div><h3 id="migrating-rows">Migrating Rows<a href="#migrating-rows" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>If the old and the new table have the same columns, we can easily transfer the data:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> projections.apps6 <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> projections.apps4;
</span></span></code></pre></div><p>In some cases, like when only some data got copied, we might need to only transfer unique entries:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> projections.users8 <span style="color:#66d9ef">source</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">EXISTS</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#ae81ff">1</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">FROM</span> projections.users10 destination 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">WHERE</span> destination.username <span style="color:#f92672">=</span> <span style="color:#66d9ef">source</span>.username
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>Only in a few rare cases you will need to specify the column names:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> login_names3_users (id, user_name, resource_owner, instance_id)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> id, user_name, resource_owner, instance_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> login_names2_users <span style="color:#66d9ef">source</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">EXISTS</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">FROM</span> login_names3_users destination
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">WHERE</span> destination.user_name <span style="color:#f92672">=</span> <span style="color:#66d9ef">source</span>.user_name
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><h3 id="deleting-the-old-table">Deleting the old table<a href="#deleting-the-old-table" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>After being sure that we migrated all the content into the right table, we can delete the old one:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">TABLE</span> projections.idp_templates2_google;
</span></span></code></pre></div><h2 id="finishing">Finishing<a href="#finishing" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>This whole process might take some time, but if you do everything correct, it will work. As I wrote before, it is best done in a test system, not in production, and normally you shouldn&rsquo;t need this article because the <code>setup</code> step from Zitadel should do this work for you.</p>
<p>If you searched for this article, I guess you could have found some bug, and probably writing a <a href="https://github.com/zitadel/zitadel/issues/new/choose">GitHub Issue</a> is also a good idea.</p>

      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        
        <span class="button next">
            <a href="https://blog.m5e.de/post/introducing-network.txt-a-standard-for-3rd-party-data-transparency/">
                <span class="button__text">Introducing network.txt: A Standard for 3rd Party Data Transparency</span>
                <span class="button__icon">â†’</span>
            </a>
        </span>
        
    </div>
</div>

  

  
    <div>
  <h2>Advertisement</h2>
  <div id="ana-container"></div>
</div>


  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2024 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>


<script>
    const adContainer = document.getElementById('ana-container');
    const url = 'https://api.anaads.de/s/BVP6CQ==';
    
     
    fetch(url)
      .then(response => response.json())
      .then(adData => {
        
        const adElement = document.createElement('div');
        adElement.classList.add('ana'); 
    
         
        const titleElement = document.createElement('span');
        const titleLink = document.createElement('a');
        titleLink.href = adData.url;
        titleLink.textContent = adData.title;
        titleElement.className = "ana-title"
        titleElement.appendChild(titleLink);
        adElement.appendChild(titleElement);
    
         
        const textElement = document.createElement('span');
        const textLink = document.createElement('a');
        textLink.href = adData.url;
        textLink.textContent = adData.text;
        textElement.className = "ana-text"
        textElement.appendChild(textLink);
        adElement.appendChild(textElement);
    
         
        adContainer.appendChild(adElement);
      })
      .catch(error => console.error(error));
</script>

  
</div>

</body>
</html>
